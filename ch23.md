# 실행컨텍스트 

- 실행컨텍스트는 자바스크립트의 동작 원리를 담고있는 핵심 개념이다. 

## 소스코드의 타입
| 소스코드의 타입 | 설명 |
|:-------------|:-----|
| 전역코드 | 전역에 존재하는 소스코드를 말한다. 전역에 정의된 함수, 클래스등의 내부코드는 포함되지 않는다. |
| 함수코드 | 함수 내부에 존재하는 소스코드를 말한다. 함수 내부에 중첩된 함수, 클래스 등의 내부 코드는 포함되지 않는다. |
| eval코드 | 빌트인 전역함수인 eval 함수에 인수로 전달되어 실행되는 소스코드를 말한다. |
| 모듈코드 | 모듈 내부에 존재하는 소스코드를 말한다. 모듈 내부의 함수, 클래스 등의 내부코드는 포함되지 않는다. |

## 소스코드의 평가와 실행 
- 자바스크립트 엔진은 소스코드를 2개의 과정, 즉 "소스코드의 평가"와 "소스코드의 실행"과정으로 나누어 처리한다. 
1. 소스코드의 평가 (선언문)
2. 소스코드의 실행 (선언문 이외의 문)
3. 실행 컨텍스트
```javascript
var x; 
x=1; 
```
|실행컨텍스트| |
|:--|:---|
| x | undefined |
- 소스 평가 과정에서 var x를 먼저 실행
- 이때 변수식별자 x는 실행컨텍스트가 관리하는 스코프에 등록되고 undefined로 초기화된다.
- 소스 코드 평가과정이 끝나면 소스코드 실행 과정이 시작된다.
|실행컨텍스트| |
|:--|:---|
| x | 1 |
- 솟코드 평가과정에서 x가 선언된 변수라면 값을 할당하고 할당결과를 실행 컨텍스트에 등록하여 관리한다. 

## 실행컨텍스트의 역할
```javascript
// 전역변수 선언
const x = 1;
const y = 2; 

// 함수 정의 
function foo(a) {
    // 지역변수 선언
    const x = 10; 
    const y = 20;
    // 메서드호출 
    console.log(a + x + y); // 
}

// 함수호출
foo(100) // 130

// 메서드 호출
console.log(x+y) // 3
```
1. 전역코드 평가
    - 소스코드 평가과정에서는 선언문만 먼저 실행한다.
    - var 키워드로 선언된 전역변수와 함수 선언문으로 정의된 전역 함수는 전역객체의 프로퍼티와 메서드가 된다. 
2. 전역코드 실행
    - 런타임이 시작되면 전역코드가 순차적으로 실행되기 시작한다. 
    - 전역 변수에 값이 할당되고 함수가 호출된다. 함수가 호출되면 전역코드의 실행을 일시 중단하고 코드 실행순서를 변경하여 함수 내부로 진입한다. 
3. 함수코드 평가
    - 매개변수와 지역변수 선언문이 먼저 실행되고 생성된 매개변수와 지역변수가 실행컨텍스트가 관리하는 지역스코프에 등록된다. 
    - 함수 내부에서 지역변수처럼 사용할수있는 arguments객체가 생성되어 지역스코프에 등록되고 this바인딩도 결정된다. 
4. 함수코드 실행
    - 함수코드 평가과정이 끝나면 런타임이 시작되어 함수코드가 순차적으로 실행되기 시작한다. 
    - 이때 매개변수와 지역변수에 값이 할당되고 console.log메서드가 호출된다. 
- 이처럼 코드가 실행되려면 스코프, 식별자, 코드실행 순서등의 관리가 필요하다. 
- 실행 컨텍스트는 소스코드를 실행하는데 필요한 환경을 제공하고 코드의 실행결과를 관리하는 영역이다. 

## 실행컨텍스트 스택
```javascript
const x = 1;
function foo() {
    const y = 2;
    function bar() {
        const z = 3; 
        console.log(x + y + z);
    }
    bar(); 
}

foo(); // 6
```
1. 전역코드의 평가와 실행
2. foo함수 코드의 평가와 실행
3. bar함수코드의 평가와 실행 
4. foo함수 코드로 복귀
5. 전역코드로 복귀
- 이처럼 스택컨텍스트 스택은 코드의 실행순서를 관리한다. 
- 실행컨텍스트스택의 최상위에 존재하는 실행컨텍스트는 언제나 현재 실행중인 코드의 실행 컨텍스트다. 

## 렉시컬 환경 
- 렉시컬 환경은 식별자와 식별자에 바인딩된 값, 그리고 상위 스코프에 대한 참조를 기록하는 자료구조로 실행 컨텍스트를 구성하는 컴포넌트다. 
- 실행컨텍스트 스택이 코드의 실행순서를 관리한다면 렉시컬 환경은 스코프와 식별자를 관리한다. 
- 렉시컬 환경은 키와 값을 갖는 객체 형태의 스코프를 생성하여 식별자를 키로 등록하고 식별자에 바인딩된 값을 관리한다. 

## 실행컨텍스트의 생성과 식별자 검색 과정 
```javascript
var x = 1; 
var y = 2;

function foo(a) {
    var x = 3; 
    const y = 4;
    function bar (b) {
        const z = 5;
        console.log(a + b+ x + y + z);
    }
    bar(10);
}
foo(20) // 42
```

### 전역객체 생성 
- 전역 객체는 전역코드가 평가되기 이전에 생성된다. 
### 전역 코드 평가
1. 전역 실행 컨텍스트 생성
2. 전역 렉시컬 환경 생성 
    2.1 전역환경 레코드 생성 
        2.1.1 객체 환경 레코드 생성
        2.1.2 선언적 환경 레코드 생성 
    2.2 this바인딩 
    2.3 외부 렉시컬 환경에 대한 참조 결정 

## 실행 컨텍스트와 블록 레벨 스코프 
```javascript 
let x = 1; 
if (true) {
    let x = 10; 
    console.log(x); // 10
}
console.log(x) // 1
```
